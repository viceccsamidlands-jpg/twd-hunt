<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mystery Rally – Hunt Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b0f14; color:#e8eef7; }
    .wrap { max-width: 900px; margin:auto; padding:16px; }
    .card { background:#121824; border-radius:14px; padding:16px; margin-bottom:14px; border:1px solid #1f2a3a; }
    .big { font-size:22px; font-weight:bold; }
    .muted { color:#a7b4c8; }
    .ok { color:#79e28a; }
    .warn { color:#f5d06f; }
    .bad { color:#ff7a7a; }

    button {
      background:#2a6df4; color:white; border:none; border-radius:10px;
      padding:12px 16px; font-size:16px; cursor:pointer; margin-right:10px; margin-top:8px;
    }
    button.secondary { background:#223149; }
    button.danger { background:#b23b3b; }

    .pill {
      display:inline-block; padding:6px 10px; background:#223149; border-radius:999px; margin-right:6px; margin-top:8px;
    }

    .videoWrap {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #1f2a3a;
      background:#000;
      margin-top: 10px;
    }
    video { width:100%; display:block; }

    .hidden { display:none; }

    /* Arrow HUD */
    .arrowHud {
      position:absolute; top:12px; left:12px; right:12px;
      display:flex; justify-content:center; pointer-events:none; z-index:5;
    }
    .arrowBadge {
      background: rgba(18,24,36,0.85);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:10px 12px;
      display:inline-flex;
      gap:10px;
      align-items:center;
      backdrop-filter: blur(6px);
    }
    .arrowIcon {
      width:44px; height:44px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      display:grid; place-items:center;
      font-size:26px;
      transform: rotate(0deg);
      transition: transform 120ms linear;
      color:#e8eef7;
    }
    .arrowText { font-size:14px; color:#a7b4c8; line-height:1.25; }
    .arrowText b { color:#e8eef7; }

    /* Arrival / checkpoint prompt */
    .promptBox {
      position:absolute; left:12px; right:12px; bottom:12px;
      background: rgba(18,24,36,0.88);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:14px 12px;
      text-align:center;
      backdrop-filter: blur(6px);
      z-index:6;
    }

    hr { border:0; border-top:1px solid #1f2a3a; margin:12px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <div class="big">Mystery Rally – Hunt Mode</div>
    <div class="muted">Launch → Checkpoints → Final Reveal</div>
    <p class="muted" style="margin-top:10px;">
      When safely parked at the launch point, press <b>Begin</b>.
      The system will guide you along the approved towing route using hidden checkpoints.
    </p>

    <button id="startBtn">Begin</button>
    <button id="mapsBtn" class="secondary">Open Next Checkpoint in Google Maps</button>
    <button id="resetProgressBtn" class="danger">Reset Progress</button>
    <button id="resetLockBtn" class="danger">Reset Device Lock</button>

    <hr />

    <div class="muted" style="font-size:13px;">
      Passenger to operate. Driver must not use phone while driving.
    </div>
  </div>

  <div class="card">
    <div id="status" class="muted">Waiting to begin…</div>

    <div style="margin-top:10px;">
      <span class="pill">Stage: <span id="stage">—</span></span>
      <span class="pill">Distance: <span id="distance">—</span></span>
      <span class="pill">Within range: <span id="within">—</span></span>
    </div>

    <div style="margin-top:10px;" class="muted">
      <div><b>Current Target:</b> <span id="targetName">—</span></div>
      <div class="mono" style="margin-top:6px; font-size:12px;">
        Target GPS: <span id="targetGps">—</span>
      </div>
    </div>

    <div class="muted" style="margin-top:10px; font-size:13px;">
      Tip: If the arrow does not appear, continue using the distance reading. Hold the phone steady for best results.
    </div>
  </div>

  <div class="card">
    <div class="videoWrap">
      <video id="video" autoplay playsinline muted></video>

      <div class="arrowHud hidden" id="arrowHud">
        <div class="arrowBadge">
          <div class="arrowIcon" id="arrowIcon">➤</div>
          <div class="arrowText">
            <b>Direction</b><br/>
            Heading: <span id="heading">—</span> · Bearing: <span id="bearing">—</span>
          </div>
        </div>
      </div>

      <div id="checkpointPrompt" class="promptBox hidden">
        <div class="big ok" id="promptTitle">Checkpoint Reached</div>
        <p style="margin: 8px 0 10px 0;" id="promptText">
          Tap below to confirm and unlock the next checkpoint.
        </p>
        <button id="confirmBtn">Confirm & Continue</button>
      </div>
    </div>
  </div>

  <div class="card hidden" id="finalCard">
    <div class="big">Final Reveal</div>

    <audio id="audio" controls>
      <source src="assets/ablution_clue.wav" type="audio/wav">
    </audio>

    <p style="margin-top:12px;">
      <b>Welcome to Gibaland.</b><br><br>
      You have solved the Mystery Rally.<br>
      Please proceed to reception and enjoy your rally weekend.
    </p>
  </div>

</div>

<script>
/* ==============================
   CONFIG
============================== */

// Route-locked checkpoints (your coordinates)
const CHECKPOINTS = [
  { id: "CP1", name: "Checkpoint 1", lat: -29.807238591373174, lng: 30.747804204036417, radius: 140 },
  { id: "CP2", name: "Checkpoint 2", lat: -29.83459372308169,  lng: 30.78418203146872,  radius: 140 },
  { id: "CP3", name: "Checkpoint 3", lat: -29.83283660010886,  lng: 30.790333586982523, radius: 140 },
  { id: "CP4", name: "Checkpoint 4", lat: -29.834303497622457, lng: 30.79023325169056,  radius: 140 },
  { id: "CP5", name: "Checkpoint 5", lat: -29.82846034830353,  lng: 30.78796680059241,  radius: 140 },

  // FINAL destination (kept hidden until the end)
  { id: "FINAL", name: "Final Destination", lat: -29.824306666522848, lng: 30.77586882598832, radius: 110, isFinal: true }
];

// Storage keys
const PROGRESS_KEY = "mystery_rally_progress_index";   // integer 0..CHECKPOINTS.length-1
const FINAL_LOCK_KEY = "mystery_rally_final_claimed";  // "1" once revealed

/* ==============================
   UI ELEMENTS
============================== */
const statusEl = document.getElementById("status");
const stageEl = document.getElementById("stage");
const distanceEl = document.getElementById("distance");
const withinEl = document.getElementById("within");
const targetNameEl = document.getElementById("targetName");
const targetGpsEl = document.getElementById("targetGps");

const startBtn = document.getElementById("startBtn");
const mapsBtn = document.getElementById("mapsBtn");
const resetProgressBtn = document.getElementById("resetProgressBtn");
const resetLockBtn = document.getElementById("resetLockBtn");

const video = document.getElementById("video");
const arrowHud = document.getElementById("arrowHud");
const arrowIcon = document.getElementById("arrowIcon");
const headingOut = document.getElementById("heading");
const bearingOut = document.getElementById("bearing");

const checkpointPrompt = document.getElementById("checkpointPrompt");
const promptTitle = document.getElementById("promptTitle");
const promptText = document.getElementById("promptText");
const confirmBtn = document.getElementById("confirmBtn");

const finalCard = document.getElementById("finalCard");
const audio = document.getElementById("audio");

/* ==============================
   STATE
============================== */
let watchId = null;
let running = false;

let currentHeading = null; // degrees 0..360
let currentBearing = null; // degrees 0..360
let compassEnabled = false;

let currentIndex = loadProgressIndex(); // 0..n-1

/* ==============================
   HELPERS
============================== */
function clampIndex(i) {
  if (!Number.isFinite(i)) return 0;
  return Math.max(0, Math.min(CHECKPOINTS.length - 1, i));
}

function loadProgressIndex() {
  const raw = localStorage.getItem(PROGRESS_KEY);
  const n = parseInt(raw, 10);
  return clampIndex(Number.isFinite(n) ? n : 0);
}

function saveProgressIndex(i) {
  currentIndex = clampIndex(i);
  localStorage.setItem(PROGRESS_KEY, String(currentIndex));
}

function formatDeg(d) {
  if (d == null || !isFinite(d)) return "—";
  return Math.round(d) + "°";
}

function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function bearingDegrees(lat1, lon1, lat2, lon2) {
  const toRad = x => x * Math.PI / 180;
  const toDeg = x => x * 180 / Math.PI;

  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);

  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
  const θ = Math.atan2(y, x);
  return (toDeg(θ) + 360) % 360;
}

function getTarget() {
  return CHECKPOINTS[currentIndex];
}

function updateTargetUI() {
  const t = getTarget();
  stageEl.textContent = `${currentIndex + 1} / ${CHECKPOINTS.length}`;
  targetNameEl.textContent = t.isFinal ? "Final Stage" : t.name;
  targetGpsEl.textContent = `${t.lat.toFixed(6)}, ${t.lng.toFixed(6)}`;

  // Keep final destination name hidden until reveal
  if (t.isFinal && localStorage.getItem(FINAL_LOCK_KEY) !== "1") {
    targetNameEl.textContent = "Final Stage (Hidden)";
  }
}

function updateArrowUI() {
  if (!compassEnabled || currentHeading == null || currentBearing == null) {
    arrowHud.classList.add("hidden");
    return;
  }
  arrowHud.classList.remove("hidden");
  headingOut.textContent = formatDeg(currentHeading);
  bearingOut.textContent = formatDeg(currentBearing);

  const rotation = (currentBearing - currentHeading + 360) % 360;
  arrowIcon.style.transform = `rotate(${rotation}deg)`;
}

async function enableCompass() {
  try {
    if (typeof DeviceOrientationEvent === "undefined") {
      compassEnabled = false;
      return false;
    }
    if (typeof DeviceOrientationEvent.requestPermission === "function") {
      const res = await DeviceOrientationEvent.requestPermission();
      if (res !== "granted") {
        compassEnabled = false;
        return false;
      }
    }
    window.addEventListener("deviceorientation", (ev) => {
      if (typeof ev.webkitCompassHeading === "number") {
        currentHeading = ev.webkitCompassHeading;
      } else if (typeof ev.alpha === "number") {
        currentHeading = (360 - ev.alpha) % 360;
      } else {
        currentHeading = null;
      }
      updateArrowUI();
    }, true);

    compassEnabled = true;
    return true;
  } catch {
    compassEnabled = false;
    return false;
  }
}

function startCamera() {
  return navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => { video.srcObject = stream; });
}

function showPrompt(title, text) {
  promptTitle.textContent = title;
  promptText.textContent = text;
  checkpointPrompt.classList.remove("hidden");
}

function hidePrompt() {
  checkpointPrompt.classList.add("hidden");
}

function showFinalIfUnlocked() {
  if (localStorage.getItem(FINAL_LOCK_KEY) === "1") {
    finalCard.classList.remove("hidden");
  } else {
    finalCard.classList.add("hidden");
  }
}

function openNextCheckpointInGoogleMaps() {
  const t = getTarget();
  const url = `https://www.google.com/maps/dir/?api=1&destination=${t.lat},${t.lng}&travelmode=driving`;
  window.open(url, "_blank");
}

/* ==============================
   GPS WATCH
============================== */
function startLocationWatch() {
  if (watchId != null) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition((pos) => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const t = getTarget();
    const d = distanceMeters(lat, lng, t.lat, t.lng);

    distanceEl.textContent = Math.round(d) + " m";
    currentBearing = bearingDegrees(lat, lng, t.lat, t.lng);
    updateArrowUI();

    const inRange = d <= t.radius;
    withinEl.textContent = inRange ? "YES" : "NO";

    if (!running) return;

    // Only prompt when in range; do NOT auto-advance (prevents accidental skipping)
    if (inRange) {
      if (t.isFinal) {
        showPrompt("Final Stage Reached", "Tap to confirm and unlock the final reveal.");
        statusEl.textContent = "You are at the final stage.";
      } else {
        showPrompt("Checkpoint Reached", "Tap to confirm and unlock the next checkpoint.");
        statusEl.textContent = "Checkpoint reached. Confirm to continue.";
      }
    } else {
      hidePrompt();
      statusEl.textContent = "Proceed to the next checkpoint (approved route).";
    }

  }, (err) => {
    statusEl.textContent = "Location error. Please enable GPS and allow location access.";
  }, { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 });
}

/* ==============================
   BUTTONS / ACTIONS
============================== */
startBtn.onclick = async () => {
  statusEl.textContent = "Starting… allow Location, Camera, and Motion if prompted.";
  updateTargetUI();
  showFinalIfUnlocked();

  try {
    await startCamera();
  } catch {
    statusEl.textContent = "Camera permission denied. Please allow camera access and try again.";
    return;
  }

  // Compass optional
  await enableCompass();

  running = true;
  startLocationWatch();
  statusEl.textContent = "Active. Follow the approved route to the next checkpoint.";
};

mapsBtn.onclick = () => {
  openNextCheckpointInGoogleMaps();
};

confirmBtn.onclick = () => {
  const t = getTarget();

  // Confirm current stage and advance
  if (t.isFinal) {
    // Unlock final reveal
    if (localStorage.getItem(FINAL_LOCK_KEY) !== "1") {
      localStorage.setItem(FINAL_LOCK_KEY, "1");
      showFinalIfUnlocked();
      audio.play().catch(() => {/* user can press play */});
    }
    hidePrompt();
    statusEl.textContent = "Final reveal unlocked.";
    updateTargetUI();
    return;
  }

  // Move to next checkpoint
  saveProgressIndex(currentIndex + 1);
  updateTargetUI();
  hidePrompt();
  statusEl.textContent = "Next checkpoint unlocked. Proceed along the approved route.";
};

resetProgressBtn.onclick = () => {
  saveProgressIndex(0);
  hidePrompt();
  updateTargetUI();
  statusEl.textContent = "Progress reset to the first checkpoint.";
};

resetLockBtn.onclick = () => {
  localStorage.removeItem(FINAL_LOCK_KEY);
  showFinalIfUnlocked();
  statusEl.textContent = "Final reveal lock reset.";
};

/* ==============================
   INIT
============================== */
updateTargetUI();
showFinalIfUnlocked();
statusEl.textContent = "Waiting to begin…";
</script>

</body>
</html>
