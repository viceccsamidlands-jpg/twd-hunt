<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mystery Rally – Hunt Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0f14;
      color: #e8eef7;
    }
    .wrap {
      max-width: 900px;
      margin: auto;
      padding: 16px;
    }
    .card {
      background: #121824;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
      border: 1px solid #1f2a3a;
    }
    button {
      background: #2a6df4;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    button.secondary { background: #223149; }
    button.danger { background: #b23b3b; }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      background: #223149;
      border-radius: 999px;
      margin-right: 6px;
    }

    video {
      width: 100%;
      border-radius: 12px;
      margin-top: 10px;
      border: 1px solid #1f2a3a;
    }

    .overlay {
      text-align: center;
      margin-top: 10px;
    }

    .hidden { display: none; }

    .big { font-size: 22px; font-weight: bold; }
    .muted { color: #a7b4c8; }
    .ok { color: #79e28a; }
    .warn { color: #f5d06f; }
    .bad { color: #ff7a7a; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <div class="big">Mystery Rally – Hunt Mode</div>
    <div class="muted">Westown Launch → Final Destination</div>
    <p>
      You have reached the launch point.  
      When safely parked, press the button below to begin your guided journey.
    </p>
    <button id="startBtn">Begin the Hunt</button>
    <button id="resetBtn" class="danger">Reset Device Lock</button>
  </div>

  <div class="card">
    <div id="status" class="muted">Waiting to begin…</div>
    <div style="margin-top:10px;">
      <span class="pill">Distance: <span id="distance">—</span></span>
      <span class="pill">Within range: <span id="within">—</span></span>
    </div>
  </div>

  <div class="card">
    <video id="video" autoplay playsinline muted></video>

    <div id="overlay" class="overlay hidden">
      <div class="big ok">You Have Arrived</div>
      <p>Tap below to reveal your final message.</p>
      <button id="revealBtn">Reveal Destination</button>
    </div>
  </div>

  <div class="card hidden" id="clueCard">
    <div class="big">Final Reveal</div>

    <audio id="audio" controls>
      <source src="assets/ablution_clue.wav" type="audio/wav">
    </audio>

    <p style="margin-top:12px;">
      <b>Welcome to Gibaland.</b><br><br>
      You have solved the Mystery Rally.<br>
      Please proceed to reception and enjoy your rally weekend.
    </p>
  </div>

  <div class="card muted">
    Passenger to operate Hunt Mode. Driver must not use phone while driving.
  </div>

</div>

<script>
const DESTINATION = {
  lat: -29.824306666522848,
  lng: 30.77586882598832,
  radius: 100
};

const LOCK_KEY = "mystery_rally_final_claimed";

const statusEl = document.getElementById("status");
const distanceEl = document.getElementById("distance");
const withinEl = document.getElementById("within");
const overlay = document.getElementById("overlay");
const clueCard = document.getElementById("clueCard");
const audio = document.getElementById("audio");

const startBtn = document.getElementById("startBtn");
const revealBtn = document.getElementById("revealBtn");
const resetBtn = document.getElementById("resetBtn");
const video = document.getElementById("video");

let watchId = null;
let isWithin = false;

function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => video.srcObject = stream);
}

function startLocationWatch() {
  watchId = navigator.geolocation.watchPosition(pos => {
    const d = distanceMeters(
      pos.coords.latitude,
      pos.coords.longitude,
      DESTINATION.lat,
      DESTINATION.lng
    );

    distanceEl.textContent = Math.round(d) + " m";

    if (d <= DESTINATION.radius) {
      isWithin = true;
      withinEl.textContent = "YES";
      overlay.classList.remove("hidden");
      statusEl.textContent = "You are at the destination.";
    } else {
      isWithin = false;
      withinEl.textContent = "NO";
      overlay.classList.add("hidden");
      statusEl.textContent = "Follow your route toward the final destination.";
    }

  }, err => {
    statusEl.textContent = "Location error. Please enable GPS.";
  }, { enableHighAccuracy: true });
}

startBtn.onclick = async () => {
  statusEl.textContent = "Starting Hunt Mode…";
  await startCamera();
  startLocationWatch();
};

revealBtn.onclick = () => {
  if (localStorage.getItem(LOCK_KEY) === "1") return;
  localStorage.setItem(LOCK_KEY, "1");
  clueCard.classList.remove("hidden");
  audio.play();
};

resetBtn.onclick = () => {
  localStorage.removeItem(LOCK_KEY);
  clueCard.classList.add("hidden");
  statusEl.textContent = "Device lock reset.";
};
</script>

</body>
</html>
